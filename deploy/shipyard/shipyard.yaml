apiVersion: "spec.keptn.sh/0.2.2"
kind: "Shipyard"
metadata:
  name: "shipyard-demoserviceapps"
spec:
  stages:
    - name: "staging"
      sequences:
            - name: "delivery"
              tasks:
                - name: "deployment"
                  properties:
                    deploymentstrategy: "direct"
                - name: "test"
                  properties:
                    teststrategy: "functional"
                - name: "evaluation"
                - name: "release"
            - name: "delivery-direct"
              tasks:
                - name: "deployment"
                  properties:
                    deploymentstrategy: "direct"
                - name: "release"
    - name: hardening
      sequences:
        - name: delivery
          triggeredOn:
          - event: staging.delivery.finished
          tasks:
          - name: deployment
            properties:
              deploymentstrategy: "direct"
          - name: "Workflow"
          - name: "njinn"
            image: "theithollow/hollowapp-blog:curl"
            args:
            - /bin/sh
            - -c
            - executionsid=$(curl -d '{"key1":"value1", "key2":"value2"}' -H "Accept: application/json" -H "Authorization: Basic ZGFuaWVsLmJyYWFmQGdtYWlsLmNvbTpLdXFEcU9xbzNZU0dnU3ExUUdFRUNZSENp" -H "content-Type: application/json" -X POST https://dynatrace.njinn.io/api/v1/workflows/31/run | jq -r '.id');
              while [["$state" == "running"]];
              do;
                state=$(curl -H "Accept: application/json" -H "Authorization: Basic ZGFuaWVsLmJyYWFmQGdtYWlsLmNvbTpLdXFEcU9xbzNZU0dnU3ExUUdFRUNZSENp" -H "content-Type: application/json" "https://dynatrace.njinn.io/api/v1/executions/$executionsid" | jq -r '.state');
                echo  $state;
              done;
          - name: "test"
            properties:
              teststrategy: "performance"
          - name: "evaluation"
          - name: release
    - name: production
      sequences:
        - name: delivery
          triggeredOn:
          - event: hardening.delivery.finished
          tasks:
          - name: deployment
            properties:
                deploymentstrategy: "direct"
          - name: release
        - name: rollback
          triggeredOn:
          - event: production.delivery.finished
            selector:
              match:
                result: failed
          tasks:
          - name: rollback
        - name: remediation
          tasks:
          - name: remediation
          - name: evaluation
            triggeredAfter: "10m"
